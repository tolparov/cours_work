package ru.sber.poirot.notifications.admin.dto

import com.fasterxml.jackson.annotation.JsonIgnore
import ru.sber.poirot.notifications.common.entity.AdminNotification

data class FeedResponse(
    val id: Long,
    val type: String,
    val message: String,
    @JsonIgnore
    val archived: Boolean,
    @JsonIgnore
    val roleIds: List<Int> = emptyList()
)

fun AdminNotification.toFeedResponse(): FeedResponse =
    FeedResponse(
        id = id,
        type = type,
        message = message,
        archived = archive,
        roleIds = mapping?.map { it.roleId } ?: emptyList()
    )


package ru.sber.poirot.notifications.admin.dto

import ru.sber.poirot.notifications.common.entity.AdminNotification
import ru.sber.poirot.notifications.common.entity.AdminNotificationRoleMapping
import java.time.LocalDateTime
import java.time.LocalDateTime.now

class CreateRequest(
    val publish: Boolean,
    val dateFrom: LocalDateTime,
    val dateTo: LocalDateTime,
    val type: String,
    val message: String,
    val roleIds: List<Int>?
) {
    override fun toString(): String {
        return "(publish=$publish, dateFrom=$dateFrom, dateTo=$dateTo, type=$type, message=$message, roleIds=$roleIds)"
    }

    fun adminNotification(login: String, roleIds: List<Int>): AdminNotification {
        val self = this
        val now = now()

        return AdminNotification().apply {
            publish = self.publish
            created = now
            lastModified = now
            dateFrom = self.dateFrom
            dateTo = self.dateTo
            type = self.type
            message = self.message
            author = login
            mapping = roleIds.map {
                AdminNotificationRoleMapping().apply { roleId = it }
            }
        }
    }
}

package ru.sber.poirot.notifications.admin.dto

import ru.sber.poirot.notifications.common.entity.AdminNotification
import ru.sber.poirot.notifications.common.entity.AdminNotificationRoleMapping
import ru.sber.sql.persister.replaceOld
import java.time.LocalDateTime

class UpdateRequest(
    val id: Long,
    val publish: Boolean,
    val lastModified: LocalDateTime?,
    val dateFrom: LocalDateTime,
    val dateTo: LocalDateTime,
    val type: String?,
    val message: String?,
    val roleIds: List<Int>?
) {
    override fun toString(): String {
        return "(id=$id, publish=$publish, dateFrom=$dateFrom, dateTo=$dateTo, type=$type, message=$message, roleIds=$roleIds)"
    }

    fun adminNotification(newRoleIds: List<Int>): AdminNotification {
        val self = this

        return AdminNotification().apply {
            id = self.id
            publish = self.publish
            lastModified = self.lastModified
            dateFrom = self.dateFrom
            dateTo = self.dateTo
            type = self.type
            message = self.message
            mapping = newRoleIds.map {
                AdminNotificationRoleMapping().apply { roleId = it }
            }.replaceOld()
        }
    }
}
