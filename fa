private fun processUpdate(sessionId: String, client: ConnectedClient, feed: FeedResponse) {
    val hasRole = feed.roleIds.isEmpty() || client.roleIds.any { it in feed.roleIds }

    when {
        // ðŸŸ¢ Ð¡Ð»ÑƒÑ‡Ð°Ð¹ 1: ÐÑ€Ñ…Ð¸Ð²Ð°Ñ†Ð¸Ñ
        feed.archived -> {
            val existingIndex = client.feed.indexOfFirst { it.id == feed.id }
            if (existingIndex != -1) {
                client.feed.removeAt(existingIndex)
                sendFullFeed(client)  // ðŸŽ¯ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑÑŒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
            }
        }

        // ðŸŸ¢ Ð¡Ð»ÑƒÑ‡Ð°Ð¹ 2: ÐžÑ‚Ð·Ñ‹Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
        !hasRole -> {
            val existingIndex = client.feed.indexOfFirst { it.id == feed.id }
            if (existingIndex != -1) {
                client.feed.removeAt(existingIndex)
                sendFullFeed(client)  // ðŸŽ¯ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑÑŒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
            }
        }

        // ðŸŸ¢ Ð¡Ð»ÑƒÑ‡Ð°Ð¹ 3: ÐÐ¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
        else -> {
            val existingIndex = client.feed.indexOfFirst { it.id == feed.id }
            if (existingIndex != -1) {
                client.feed[existingIndex] = feed
            } else {
                client.feed.add(feed)
            }
            sendFullFeed(client)  // ðŸŽ¯ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑÑŒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
        }
    }
}

// ðŸŽ¯ Ð•Ð´Ð¸Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
private fun sendFullFeed(client: ConnectedClient) {
    try {
        val activeMessages = client.feed.filter { !it.archived }  // Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ
        val wsMsg = WsMessage.data(activeMessages).toJson()
        
        client.session.send(Mono.just(client.session.textMessage(wsMsg)))
            .doOnError { e ->
                log.error("Failed to send feed to {}: {}", client.session.id, e.message)
                unregister(client.session.id)
            }
            .subscribe()
    } catch (e: Exception) {
        log.error("Error sending feed", e)
        unregister(client.session.id)
    }
}
