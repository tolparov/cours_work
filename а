@RestController
@RequestMapping("/api/cycle-operations")
class CycleOperationsController(
    private val audit: AuditClient,
    private val cycleOperations: CycleOperations
) {

    // --- 1. Получение списка доступных периодов ---
    @GetMapping("/periods")
    @PreAuthorize(HAS_RING_OPERATIONS)
    suspend fun getAvailablePeriods(
        @Parameter(description = "ИНН ЮЛ/ИП") inn: Inn
    ) = audit.audit(
        event = "DOSSIER_BY_LE_INN_PERIODS_FETCHED",
        details = "inn: $inn"
    ) {
        cycleOperations.getAvailablePeriods(inn)
    }

    // --- 2. Получение данных за конкретный год и квартал ---
    @GetMapping
    @PreAuthorize(HAS_RING_OPERATIONS)
    suspend fun getCycleOperations(
        @Parameter(description = "ИНН ЮЛ/ИП") inn: Inn,
        @Parameter(description = "Год") year: Int,
        @Parameter(description = "Квартал") quarter: Int
    ) = audit.audit(
        event = "DOSSIER_BY_LE_INN_FETCHED",
        details = "inn: $inn, year: $year, quarter: $quarter"
    ) {
        cycleOperations.getCycleOperations(inn, year, quarter)
    }
}

interface CycleOperations {
    suspend fun getAvailablePeriods(inn: Inn): List<CyclePeriod>
    suspend fun getCycleOperations(inn: Inn, year: Int, quarter: Int): FindCycleRs
}
@Service
class CycleOperationsImpl(
    private val loopsClient: LoopsClient
) : CycleOperations {

    override suspend fun getAvailablePeriods(inn: Inn): List<CyclePeriod> {
        val request = FindAllCycleRq(epkId = inn.value)
        val response = loopsClient.findAvailablePeriods(request)
        return response.availablePeriods
    }

    override suspend fun getCycleOperations(inn: Inn, year: Int, quarter: Int): FindCycleRs {
        val request = FindCycleRq(epkId = inn.value, year = year, quarter = quarter)
        return loopsClient.findCycleOperations(request)
    }
}

