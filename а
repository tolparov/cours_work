package ru.sber.poirot.notifications.websocket

import org.springframework.web.reactive.socket.WebSocketSession
import reactor.core.publisher.Mono
import ru.sber.poirot.notifications.admin.dto.FeedResponse
import ru.sber.poirot.notifications.admin.dto.WsMessage
import ru.sber.toJson
import java.util.concurrent.ConcurrentHashMap

object BroadcastRegistry {

    private val clients = ConcurrentHashMap<String, ConnectedClient>()

    data class ConnectedClient(
        val session: WebSocketSession,
        val roleIds: Set<Int>,
        val feed: MutableList<FeedResponse> = mutableListOf()
    )

    fun register(
        sessionId: String,
        session: WebSocketSession,
        roleIds: Set<Int>,
        initialFeed: List<FeedResponse>
    ) {
        clients[sessionId] = ConnectedClient(session, roleIds, initialFeed.toMutableList())
    }

    fun unregister(sessionId: String) {
        clients.remove(sessionId)
    }

    fun publish(feedResponses: List<FeedResponse>) {
        feedResponses.forEach { feed ->
            clients.forEach { (_, client) ->
                if (!client.session.isOpen) return@forEach

                val hasRole = client.roleIds.any { it in feed.roleIds }
                val existingIndex = client.feed.indexOfFirst { it.id == feed.id }

                when {
                    feed.archived -> {
                        if (existingIndex != -1) {
                            client.feed.removeAt(existingIndex)
                            sendUpdate(client, listOf(feed))
                        }
                    }

                    existingIndex == -1 && hasRole -> {
                        client.feed.add(feed)
                        sendUpdate(client, listOf(feed))
                    }

                    // ðŸ”¹ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (update)
                    existingIndex != -1 && hasRole -> {
                        client.feed[existingIndex] = feed
                        sendUpdate(client, listOf(feed))
                    }
                }
            }
        }
    }

    private fun sendUpdate(client: ConnectedClient, feeds: List<FeedResponse>) {
        val wsMsg = WsMessage.data(feeds).toJson()
        client.session.send(Mono.just(client.session.textMessage(wsMsg))).subscribe()
    }
}
