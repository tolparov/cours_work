package ru.sber.poirot.notifications.config

import org.springframework.context.annotation.Configuration
import org.springframework.messaging.simp.config.MessageBrokerRegistry
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker
import org.springframework.web.socket.config.annotation.StompEndpointRegistry
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer

@Configuration
@EnableWebSocketMessageBroker
class WebSocketConfig : WebSocketMessageBrokerConfigurer {

    override fun registerStompEndpoints(registry: StompEndpointRegistry) {
        registry.addEndpoint("/ws/notifications")
            .setAllowedOriginPatterns("*")
            .withSockJS()
    }

    override fun configureMessageBroker(registry: MessageBrokerRegistry) {
        registry.enableSimpleBroker("/topic")
        registry.setApplicationDestinationPrefixes("/app")
    }
}
package ru.sber.poirot.notifications.websocket

import org.springframework.messaging.handler.annotation.MessageMapping
import org.springframework.messaging.handler.annotation.SendTo
import org.springframework.stereotype.Controller
import ru.sber.poirot.notifications.admin.AdminNotifications
import ru.sber.poirot.notifications.admin.dto.FeedResponse

@Controller
class FeedWebSocketController(
    private val adminNotifications: AdminNotifications
) {

    /**
     * –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /app/feed/init
     * –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
     */
    @MessageMapping("/feed/init")
    @SendTo("/topic/feed")
    suspend fun initFeed(): List<FeedResponse> {
        return adminNotifications.feed()
    }
}package ru.sber.poirot.notifications.websocket

import org.springframework.messaging.simp.SimpMessagingTemplate
import org.springframework.stereotype.Service
import ru.sber.poirot.notifications.admin.dto.FeedResponse

@Service
class FeedBroadcaster(
    private val simpMessagingTemplate: SimpMessagingTemplate
) {
    fun broadcast(feed: List<FeedResponse>) {
        simpMessagingTemplate.convertAndSend("/topic/feed", feed)
    }

    fun broadcastSingle(feed: FeedResponse) {
        broadcast(listOf(feed))
    }
}
@Service
class AdminNotificationsImpl(
    private val adminNotificationsDao: AdminNotificationsDao,
    private val rolesDao: RolesDao,
    private val currentUser: CurrentUser,
    private val feedBroadcaster: FeedBroadcaster
) : AdminNotifications {

    override suspend fun create(request: CreateRequest): NotificationResponse {
        val newRoleIds = chooseRoleIds(request.roleIds)
        val notification = request.adminNotification(currentUser.userName(), newRoleIds)

        adminNotificationsDao.insert(notification)
        val response = notification.notificationResponse()

        // üí• –ü—É—à–∏–º —Å–≤–µ–∂—É—é –∑–∞–ø–∏—Å—å –≤—Å–µ–º, —É –∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–æ feed-–æ–∫–Ω–æ
        feedBroadcaster.broadcastSingle(notification.toFeedResponse())

        return response
    }

    override suspend fun update(request: UpdateRequest) {
        if (!adminNotificationsDao.existsNotArchivedWithId(request.id)) {
            throw FrontException(NOTIFICATION_NOT_FOUND_OR_ARCHIVED)
        }

        val notification = request.adminNotification(chooseRoleIds(request.roleIds))
        adminNotificationsDao.merge(notification)

        // üí• –ø—É—à–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        feedBroadcaster.broadcastSingle(notification.toFeedResponse())
    }

    override suspend fun archive(id: Long) {
        val notification = adminNotificationsDao.fetchById(id).apply { archive = true }
        adminNotificationsDao.merge(notification)

        // üí• –º–æ–∂–Ω–æ –ø—É—à–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ª–µ–Ω—Ç—É (3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
        feedBroadcaster.broadcast(adminNotificationsDao.feed(currentUser.rolesIds().toSet()).map { it.toFeedResponse() })
    }
}


