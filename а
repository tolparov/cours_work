object BroadcastRegistry {

    private val clients = ConcurrentHashMap<String, ConnectedClient>()

    data class ConnectedClient(
        val session: WebSocketSession,
        val roleIds: Set<Int>
    )

    fun register(sessionId: String, session: WebSocketSession, roleIds: Set<Int>) {
        clients[sessionId] = ConnectedClient(session, roleIds)
    }

    fun unregister(sessionId: String) {
        clients.remove(sessionId)
    }

    fun publish(feedResponses: List<FeedResponse>) {
        feedResponses.forEach { feed ->
            clients.forEach { (_, client) ->
                if (client.session.isOpen &&
                    client.roleIds.any { it in feed.roleIds }
                ) {
                    val wsMsg = WsMessage.data(listOf(feed)).toJson()
                    client.session.send(Mono.just(client.session.textMessage(wsMsg))).subscribe()
                }
            }
        }
    }
}
