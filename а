package ru.sber.poirot.ai.chat.client.impl

import org.springframework.stereotype.Service
import ru.sber.poirot.ai.chat.client.AIChatClient
import ru.sber.poirot.ai.chat.configs.AIChatClientProperties
import ru.sber.poirot.ai.chat.dto.AskDto
import ru.sber.poirot.ai.chat.dto.agent.AiAgentRequest
import ru.sber.poirot.ai.chat.dto.agent.ModelSettingsDto
import ru.sber.poirot.webclient.dsl.DslWebClient
import ru.sber.poirot.webclient.dsl.post

@Service
class AIChatClientImpl(
    private val dslClient: DslWebClient,
    private val props: AIChatClientProperties
) : AIChatClient {

    override suspend fun sendMessage(request: AskDto): String? {
        val url = props.baseUrl.replace("{threadUid}", request.threadUid)

        val model = props.modelSettings
        val modelSettings = ModelSettingsDto(
            max_tokens = model.maxTokens,
            model = model.model,
            repetition_penalty = model.repetitionPenalty,
            temperature = model.temperature,
            top_p = model.topP
        )

        val body = AiAgentRequest(
            message = request.message,
            modelSettings = modelSettings,
            attachments = null
        )

        return dslClient.post<String> {
            path = url
            this.body = body
        }
    }
}
